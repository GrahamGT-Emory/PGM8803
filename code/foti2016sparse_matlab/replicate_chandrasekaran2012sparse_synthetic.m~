
% replicates experiments in section 6.1 of Chadrasekaran et al. 2012
% figure 1

% %% construct data for synthetic data experiment in Chadrasekaran et al.
% % 2012, section 6.1 - 36-cycle, 2 latent variables
% p = 36;
% h = 2;
% S = zeros(p+h);
% r = 0.25;
% % Add partial correlation edges 
% for ii = 0:(p-1)
%     S(ii, mod(ii+1,p)) = r;
%     S(mod(ii+1,p), ii) = r;
%     S(ii, mod(ii-1,p)) = r;
%     S(mod(ii-1,p), ii) = r;
% end
% % Latent variables connected to random subset of observed variables
% subset_percent = 0.8;
% for ii = 0:(h-1)
%     ind = randperm(p,round(subset_percent*p));
%     S(ind,ii) = rand(1,round(subset_percent*p));
%     S(ii, ind) = rand(1,round(subset_percent*p));
% end
% C = inv(S);
% n = 100*p;
% % XU is [p+h x n] synthetic data
% XU = (randn(n, p+h) * chol(C))'; 
% 
% SampleC = XU(1:p,:);

%% construct data for synthetic data experiment in Chadrasekaran et al.
% 2012 - Ming Yuan Georgia Tech, section 6.1 - 36-cycle, 2 latent variables
clc; clear;

p = 20;
h = 10;
S = eye(p+h);
r = 0.2;
% p random locations on a 1x1 square
locs = rand(p, 2);
% Add partial correlation edges 
for ii = 1:p
    for jj = 1:p
        if ii < jj
            add_edge = rand() < (2 * normpdf(norm(locs(ii,:) - locs(jj,:),2) * sqrt(p)));
            S(ii, jj) = r * add_edge;
        end
    end
end
% Remove edges when nodes have more than four edges connected to it
for ii = 1:p
    [node_edges] = find(S(ii,:) > 0);
    if length(node_edges) > 5
        idx_delete = randperm(length(node_edges));
        S(ii, node_edges(idx_delete(6:end))) = 0;
        S(node_edges(idx_delete(6:end)),ii) = 0;
    end 
    S(ii, ii) = 1;
end
S = (S + S') - (eye(p+h).*diag(S)); 

% Latent variables connected to random subset of observed variables
subset_percent = 1;
for ii = (p+1):(p+h)
    ind = randperm(p,round(subset_percent*p));
    vals = 0.12*rand(1,round(subset_percent*p));
    S(ind,ii) = vals;
    S(ii, ind) = vals;
    for jj = (p+1):(p+h)
        if ii == jj
            S(ii, jj) = 1;
        else
            % Latent Variables connection weights
            S(ii, jj) = 0;
        end  
    end
end

S_obs_marginal = S(1:p,1:p) - (S(1:p,p+1:end)*inv(S(p+1:end,p+1:end))*S(p+1:end,1:p));
C = inv(S_obs_marginal);
% unity variances`

n = 200;%0.6*(p); % from meinshausen 2006, pg 1449
% X is [p x n] synthetic data
X = (randn(n, p) * chol(C))'; 
threshold = 0;



%% Optimization

C_sample = (1/(n-1))*(X*X');
params_glasso.alpha_sweep = logspace(-1,0,5);
params_lvglasso.alpha_sweep = logspace(-1,0,5);
params_lvglasso.beta_sweep = logspace(-1,0,5);
lv_history = [];
glasso_history = [];
best_f1_glasso = 0;

for ia = 1:length(params_lvglasso.alpha_sweep)
  targets = abs(S(1:p, 1:p)) > threshold;
  for ib = 1:length(params_lvglasso.beta_sweep)
    alpha = params_lvglasso.alpha_sweep(ia);
    beta = params_lvglasso.beta_sweep(ib);
    % --- solve with lvglasso ---
    [S_lv,L_lvglasso,info_lvglasso] = lvglasso(C_sample, alpha, beta);
    [f1_score] = evaluateGraph(abs(S_lv) > threshold, targets);
    
    % Create struct
    meta_data.alpha = alpha;
    meta_data.beta = beta;
    meta_data.f1 = f1_score;
    meta_data.S = S_lv;
    meta_data.L = L_lvglasso;
    meta_data.info = info_lvglasso;
    lv_history = [lv_history meta_data]; %#ok<*AGROW>
  end
end

for ia = 1:length(params_glasso.alpha_sweep)
    alpha = params_glasso.alpha_sweep(ia);
    % --- solve with glasso ---
    [S_glasso,L_glasso,info_glasso] = glasso(C_sample, alpha);
    [fl_score] = evaluateGraph(abs(S_glasso) > threshold, targets);
    
    % Create struct
    meta_data.alpha = alpha;
    meta_data.f1 = f1_score;
    meta_data.S = S_glasso;
    meta_data.info = info_glasso;
    glasso_history = [glasso_history meta_data]; %#ok<*AGROW>
end

%% Plot results

close all;
subplot 221
G = graph(abs(S(1:p,1:p)) > threshold);
plot(G,'XData',locs(:,1),'YData',locs(:,2));
title('True Graph')

subplot 222
[~, loc] = max([lv_history.f1]);
G = graph(abs(lv_history(loc).S) > threshold);
plot(G,'XData',locs(:,1),'YData',locs(:,2));
title('LV-Glasso')

subplot 223
[~, loc] = max([glasso_history.f1]);
G = graph(abs(glasso_history(loc).S) > threshold);
plot(G,'XData',locs(:,1),'YData',locs(:,2));
title('LV-Glasso')



